<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  /* HEAD CSS */
</head>
<body>
  <main data-fetch-key="0" class="page-content">
    <div class="columns__2 columns-gaps-medium">
      <div class="column has-width" style="flex-basis:100%;flex-grow:100;">

  <h1>Event Example</h1>

  <div style="display:none;" class="eventcard eventcard__type-default eventcard__size-small">
    <figure class="eventcard__image">
      <picture>
        <img src="https://assets.volteuropa.org/styles/crop_240x160/public/2022-03/MVE_Welcome.jpg"  alt="Meet Volt Europa welcome banner" loading="lazy">
      </picture>
    </figure>
    <div class="event__details eventcard__content">
      <h4 class="event__details__title">
        <span>Meet Volt Europa March 2023</span>
      </h4>
      <div class="event__details__organizer-language">
        Volt Europa,
        English
      </div>
      <div class="event__details__time">
        <span> 22.03.2023, 19:00</span>
      </div>
      <div class="event__details__description">
        Have you ever wondered what’s it like to hang out with people passionate about shaping the future of Europe? Now is the time to find out! 
      </div>
      <!---->
      <div class="event__details__link">
        <a href="https://us06web.zoom.us/j/85159675442?pwd=aE1uWWI0SnNxc1QxbzdHcUJqTTBtQT09" target="_blank" rel="noopener">https://us06web.zoom.us/j/85159675442?pwd=aE1uWWI0SnNxc1QxbzdHcUJqTTBtQT09</a>
      </div>
      <!---->
      <script type="application/ld+json">{"@context":"https://schema.org","@type":"Event","name":"Meet Volt Europa March 2023","url":"https://www.volteuropa.org/events_MVE_march_23","description":"Have you ever wondered what’s it like to hang out with people passionate about shaping the future of Europe? Now is the time to find out! ","startDate":"2023-03-22T18:00:00+00:00","endDate":"2023-03-22T19:30:00+00:00","image":["https://assets.volteuropa.org/2022-03/MVE_Welcome.jpg"],"organizer":{"@type":"Organization","name":"Volt Europa","url":"https://www.volteuropa.org","logo":{"@type":"ImageObject","url":"https://www.volteuropa.org/volt-logo.png"}},"location":{"@type":"VirtualLocation","url":"https://us06web.zoom.us/j/85159675442?pwd=aE1uWWI0SnNxc1QxbzdHcUJqTTBtQT09"},"sameAs":[]}</script>
    </div>
    <div class="eventcard__spacer"></div>
    <div class="eventcard__infoButton">
      <a href="https://www.volteuropa.org/events_MVE_march_23" hreflang="en">Mehr Informationen</a>
    </div>
  </div>





    <div id="events_wrapper" class="custom_event_grid cards events cards__cardSize-small"></div>

    <script>

      const now = new Date().toISOString().split('T')[0]
      const start_date = new Date(new Date().setDate(new Date().getDate() - 360)).toISOString().split('T')[0]
      const end_date = new Date(new Date().setDate(new Date().getDate() + 360)).toISOString().split('T')[0]

      const ical_url = 'https://calendar.google.com/calendar/ical/c_8dguqa58qlft5to7i3j1uqbprk%40group.calendar.google.com/public/basic.ics'

      const default_image = 'https://assets.volteuropa.org/styles/crop_320x160_2x/public/2021-10/volt_bb_thumbnail-presse.webp'

      const event_card_html = `<div class="eventcard eventcard__type-default eventcard__size-small">
        <figure class="eventcard__image">
          <picture>
            <img src="{{image}}" alt="" loading="lazy">
          </picture>
        </figure>
        <div class="event__details eventcard__content">
          <h4 class="event__details__title">
            <span>{{summary}}</span>
          </h4>
          <div class="event__details__time">
            <span> {{start_date}}</span>
          </div>
          <div class="event__details__organizer-language">
            {{organizer}}
          </div>
          <div class="event__details__description">
            {{description}}
          </div>
          {{google_meet_link}}
        </div>
      </div>`

      function linkify(inputText) {
        // source: https://stackoverflow.com/questions/37684/how-to-replace-plain-urls-with-links
        // this would be better: https://linkify.js.org/

        // http://, https://, ftp://
        var urlPattern = /\b(?:https?|ftp):\/\/[a-z0-9-+&@#\/%?=~_|!:,.;]*[a-z0-9-+&@#\/%=~_|]/gim;

        // www. sans http:// or https://
        var pseudoUrlPattern = /(^|[^\/])(www\.[\S]+(\b|$))/gim;

        // Email addresses
        var emailAddressPattern = /[\w.]+@[a-zA-Z_-]+?(?:\.[a-zA-Z]{2,6})+/gim;

        return inputText
          .replace(urlPattern, '<a href="$&" target="_blank">$&</a>')
          .replace(pseudoUrlPattern, '$1<a href="http://$2" target="_blank">$2</a>')
          .replace(emailAddressPattern, '<a href="mailto:$&">$&</a>');
      }

      function format_date(date) {
        date = new Date(date)

        const day = date.getDate().toString().padStart(2, '0'); // get the day of the month and pad it with leading zeros if necessary
        const month = (date.getMonth() + 1).toString().padStart(2, '0'); // get the month (zero-indexed) and add one, then pad it with leading zeros if necessary
        const year = date.getFullYear(); // get the full year (e.g. 2023)
        const hours = date.getHours().toString().padStart(2, '0'); // get the hours and pad it with leading zeros if necessary
        const minutes = date.getMinutes().toString().padStart(2, '0'); // get the minutes and pad it with leading zeros if necessary

        let formattedTime = `${hours}:${minutes}`;
        if (hours === '00' && minutes === '00') {
          formattedTime = '';
        }

        const formattedDate = `${day}.${month}.${year}${formattedTime ? `, ${formattedTime}` : ''}`; // concatenate the date and time into the desired format, omitting the time if it's zero

        return formattedDate;
      }

      function get_plaintext(html) {
        html = html
          .replace(/<br\s*\/?>/g, '\n')
          .replace(/<p>/g, '\n')
          .replace(/<\/p>/g, '\n')
          .replace(/(<\/li>)/g, '$1\n')
          .replace(/(<\/ul>)/g, '$1\n')
        let tmp_description = document.createElement('div')
        tmp_description.innerHTML = html
        return tmp_description.textContent || tmp_description.innerText || ''
      }
      function show_events(events) {
        const events_wrapper_element = document.getElementById('events_wrapper')
        events_wrapper_element.innerHTML = ''

        events
          .sort((a, b) => new Date(a.dtstart).valueOf() - new Date(b.dtstart).valueOf())
          .forEach(event => {
            const event_element = document.createElement('div')


            let description = get_plaintext(event.description || '')
            description = linkify(description)
              .replace(/(?:\r\n|\r|\n){3,}/g, '\n\n') // remove multiple newlines
              .replace(/^[\n\s]+/g, '') // remove leading newlines
              .replace(/[\n\s]+$/g, '') // remove trailing newlines
              .replace(/Über Google Meet teilnehmen:(?:.|\n)*/g, '') // remove google meets clutter

            const cut_lenght = 200
            const check_lenght = cut_lenght + 10
            if (description.length > check_lenght) {
              const first_part = description
                .substring(0, cut_lenght)
                .replace(/\n/g, '<br />') // replace newlines with <br />
              const second_part = description.substring(cut_lenght)
                .replace(/\n/g, '<br />') // replace newlines with <br />

              description = `
                <details>
                  <summary>${first_part}</summary>${second_part}
                </details>
              `
            } else {
              description = description
                .replace(/\n/g, '<br />') // replace newlines with <br />
            }

            let this_event_card_html = event_card_html
              .replace('{{image}}', event.image || default_image)
              .replace('{{summary}}', event.summary || '')
              .replace('{{description}}', description)
              .replace('{{start_date}}', format_date(event.dtstart || ''))
              .replace('{{organizer}}', event.location || 'Volt Brandenburg')

            if (event['x-google-conference']) {
              this_event_card_html = this_event_card_html
                .replace('{{google_meet_link}}', `
                  <div class="eventcard__infoButton">
                    <a href="${event['x-google-conference']}" target="_blank" rel="noopener">In Google Meet teilnehmen</a>
                  </div>
                `)
            } else {
              this_event_card_html = this_event_card_html
                .replace('{{google_meet_link}}', '')
            }

            event_element.innerHTML = this_event_card_html
            events_wrapper_element.appendChild(event_element.firstChild)
          })
      }

      let events_url = `https://api.volt.link/events.json?url[]=${ical_url}&start=${start_date}&end=${end_date}`
      if (window.location.hostname === 'localhost') {
        events_url = `http://localhost:4004/events.json?url[]=${ical_url}&start=${start_date}&end=${end_date}`
      }

      fetch(events_url)
        .then(response => response.json())
        .then(data => {
          if (typeof data.error === 'string' && data.error.length > 0) {
            throw new Error(data.error)
          } else {
            show_events(data.events)
          }
        })
        .catch(console.error)
    </script>

    <style>
      .custom_event_grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        grid-gap: 1rem;
        width: 100%;
      }
    
      .custom_event_grid a {
        text-underline-offset: .05em;
      }
      .custom_event_grid .eventcard__image {
        min-height: 7rem;
        aspect-ratio: 2/1;
        height: auto;
      }
      .custom_event_grid .eventcard .event__details__organizer-language {
        padding-top: 16px;
      }
      .custom_event_grid .eventcard .event__details__time{
        padding-top: 4px;
      }
      .custom_event_grid .eventcard .event__details__description p:first-of-type{
        margin-block-start: 0;
      }
      .custom_event_grid .eventcard .event__details__description p:last-of-type{
        margin-block-end: 0;
      }
      .custom_event_grid details summary {
        display: inline;
        cursor: pointer;
        /* margin-inline-end: -4px; */
      }
      .custom_event_grid details summary:hover {
        opacity: .8;
      }
      .custom_event_grid details summary:after {
        content: '…';
      }
      .custom_event_grid details[open] summary:after {
        content: '';
      }
    </style>






      </div>
    </div>
  </main>
</body>
</html>
